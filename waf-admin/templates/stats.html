<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ WAF - NexusWAF</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .stat-item {
            padding: 1.5rem;
            background: rgba(6, 182, 212, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(6, 182, 212, 0.1);
            border-left: 3px solid #06b6d4;
            transition: all 0.3s ease;
        }
        
        .stat-item:hover {
            transform: translateY(-3px);
            border-left-color: #0ea5e9;
            background: rgba(6, 182, 212, 0.1);
        }
        
        .stat-item-label {
            color: #94a3b8;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-bottom: 0.5rem;
        }
        
        .stat-item-value {
            color: #0ea5e9;
            font-size: 1.8rem;
            font-weight: 700;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
            <a href="/" class="navbar-brand" style="display: flex; align-items: center; gap: 0.75rem;"><svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg" style="filter: drop-shadow(0 0 10px rgba(6, 182, 212, 0.6));"><path d="M16 2L4 8V14C4 23 16 30 16 30C16 30 28 23 28 14V8L16 2Z" fill="url(#gradient)" stroke="#0ea5e9" stroke-width="1.5"/><defs><linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#06b6d4;stop-opacity:1" /><stop offset="100%" style="stop-color:#0ea5e9;stop-opacity:1" /></linearGradient></defs></svg>NexusWAF</a>
            <ul class="navbar-nav">
                <li><a href="/" class="nav-link">–ì–ª–∞–≤–Ω–∞—è</a></li>
                <li><a href="/config" class="nav-link">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</a></li>
                <li><a href="/logs" class="nav-link">–õ–æ–≥–∏</a></li>
                <li><a href="/stats" class="nav-link active">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <!-- Main Chart -->
        <div class="card">
            <h2 style="display: flex; align-items: center; gap: 0.5rem;">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É–≥—Ä–æ–∑ –ø–æ —Ç–∏–ø–∞–º</h2>
            <div class="chart-container" style="height: 400px;">
                <canvas id="threatsChart"></canvas>
            </div>
        </div>

        <!-- Key Metrics -->
        <div class="card" style="margin-top: 2rem;">
            <h2 style="display: flex; align-items: center; gap: 0.5rem;">–ö–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h2>
            <div class="stats-grid" id="keyMetrics">
                <div class="stat-item">
                    <div class="stat-item-label">–í—Å–µ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤</div>
                    <div class="stat-item-value" id="totalReqs">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-item-label">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ</div>
                    <div class="stat-item-value" id="blockedReqs">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-item-label">–£—Å–ø–µ—à–Ω—ã—Ö</div>
                    <div class="stat-item-value" id="successReqs">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-item-label">–ü—Ä–æ—Ü–µ–Ω—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏</div>
                    <div class="stat-item-value" id="blockRate">0%</div>
                </div>
            </div>
        </div>

        <!-- Detailed Stats -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 2rem;">
            <!-- General Statistics -->
            <div class="card">
                <h3 style="display: flex; align-items: center; gap: 0.5rem;">–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                <div id="generalStats" class="stats-grid">
                    <div class="loading" style="margin-top: 2rem; margin-left: auto; margin-right: auto;"></div>
                </div>
            </div>

            <!-- Threats by Type -->
            <div class="card">
                <h3 style="display: flex; align-items: center; gap: 0.5rem;">–£–≥—Ä–æ–∑—ã –ø–æ —Ç–∏–ø–∞–º</h3>
                <div id="efficiencyStats" class="stats-grid">
                    <div class="loading" style="margin-top: 2rem; margin-left: auto; margin-right: auto;"></div>
                </div>
            </div>
        </div>

        <!-- Additional Info -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 2rem;">
            <div class="card">
                <h3 style="display: flex; align-items: center; gap: 0.5rem;">‚è±–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</h3>
                <div id="lastUpdate" style="color: #94a3b8; margin-top: 1rem;">
                    <div class="loading"></div>
                </div>
            </div>
            
            <div class="card">
                <h3 style="display: flex; align-items: center; gap: 0.5rem;">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h3>
                <div style="margin-top: 1rem;">
                    <div id="recommendations" style="color: #94a3b8; line-height: 1.6;">
                        <p>–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –¥–∞–Ω–Ω—ã–µ...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let threatsChart;

        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const stats = await response.json();
                
                updateCharts(stats);
                updateStatsDisplay(stats);
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        function updateCharts(stats) {
            const ctx = document.getElementById('threatsChart').getContext('2d');
            
            if (threatsChart) {
                threatsChart.destroy();
            }

            const threats = {
                sqli: stats.threats_by_type.sqli || 0,
                xss: stats.threats_by_type.xss || 0,
                cmdi: stats.threats_by_type.cmdi || 0,
                pathtraversal: stats.threats_by_type.pathtraversal || 0
            };

            const threatsData = {
                labels: ['üî¥ SQL Injection', 'üü† XSS', 'üü£ Command Injection', 'üîµ Path Traversal'],
                datasets: [{
                    data: [threats.sqli, threats.xss, threats.cmdi, threats.pathtraversal],
                    backgroundColor: [
                        'rgba(239, 68, 68, 0.8)',
                        'rgba(249, 115, 22, 0.8)',
                        'rgba(168, 85, 247, 0.8)',
                        'rgba(6, 182, 212, 0.8)'
                    ],
                    borderColor: [
                        '#ef4444',
                        '#f97316',
                        '#a855f7',
                        '#06b6d4'
                    ],
                    borderWidth: 2
                }]
            };

            threatsChart = new Chart(ctx, {
                type: 'doughnut',
                data: threatsData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#94a3b8',
                                padding: 15,
                                font: {
                                    size: 12,
                                    weight: 600
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateStatsDisplay(stats) {
            const blockRate = stats.total_requests > 0 ? 
                ((stats.blocked_requests / stats.total_requests) * 100).toFixed(2) : 0;
            
            const successReqs = stats.total_requests - stats.blocked_requests;

            // Update key metrics
            document.getElementById('totalReqs').textContent = stats.total_requests.toLocaleString();
            document.getElementById('blockedReqs').textContent = stats.blocked_requests.toLocaleString();
            document.getElementById('successReqs').textContent = successReqs.toLocaleString();
            document.getElementById('blockRate').textContent = blockRate + '%';

            // General stats
            const generalStats = document.getElementById('generalStats');
            generalStats.innerHTML = `
                <div class="stat-item">
                    <div class="stat-item-label">–í—Å–µ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤</div>
                    <div class="stat-item-value">${stats.total_requests.toLocaleString()}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-item-label">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ</div>
                    <div class="stat-item-value" style="color: #ef4444;">${stats.blocked_requests.toLocaleString()}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-item-label">‚úì –£—Å–ø–µ—à–Ω—ã—Ö</div>
                    <div class="stat-item-value" style="color: #10b981;">${successReqs.toLocaleString()}</div>
                </div>
            `;

            // Efficiency stats
            const efficiencyStats = document.getElementById('efficiencyStats');
            const threats = stats.threats_by_type;
            efficiencyStats.innerHTML = `
                <div class="stat-item" style="border-left-color: #ef4444;">
                    <div class="stat-item-label">üî¥ SQL Injection</div>
                    <div class="stat-item-value" style="color: #ef4444;">${threats.sqli || 0}</div>
                </div>
                <div class="stat-item" style="border-left-color: #f97316;">
                    <div class="stat-item-label">üü† XSS</div>
                    <div class="stat-item-value" style="color: #f97316;">${threats.xss || 0}</div>
                </div>
                <div class="stat-item" style="border-left-color: #a855f7;">
                    <div class="stat-item-label">üü£ Command Injection</div>
                    <div class="stat-item-value" style="color: #a855f7;">${threats.cmdi || 0}</div>
                </div>
                <div class="stat-item" style="border-left-color: #06b6d4;">
                    <div class="stat-item-label">üîµ Path Traversal</div>
                    <div class="stat-item-value" style="color: #06b6d4;">${threats.pathtraversal || 0}</div>
                </div>
            `;

            // Last update
            const lastUpdate = new Date(stats.last_updated);
            document.getElementById('lastUpdate').innerHTML = `
                <div style="color: #0ea5e9; font-weight: 600;">
                    ${lastUpdate.toLocaleString('ru-RU')}
                </div>
                <div style="color: #94a3b8; font-size: 0.85rem; margin-top: 0.5rem;">
                    –û–±–Ω–æ–≤–ª–µ–Ω–∏—è: –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
                </div>
            `;

            // Recommendations
            const recommendations = document.getElementById('recommendations');
            let recommendationText = '';
            
            if (blockRate > 10) {
                recommendationText = '‚ö†Ô∏è –í—ã—Å–æ–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∞—Ç–∞–∫. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –∏ —É—Å–∏–ª–∏—Ç—å –∑–∞—â–∏—Ç—É.';
            } else if (blockRate > 5) {
                recommendationText = '‚ö° –£–º–µ—Ä–µ–Ω–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å. –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–∏—Å—Ç–µ–º—ã.';
            } else if (blockRate > 0) {
                recommendationText = '‚úì –ù–∏–∑–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∞—Ç–∞–∫. –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ.';
            } else {
                recommendationText = '‚úì –ê—Ç–∞–∫ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ. –°–∏—Å—Ç–µ–º–∞ –∑–∞—â–∏—â–µ–Ω–∞ –æ—Ç–ª–∏—á–Ω–æ!';
            }

            if (threats.sqli > 0) {
                recommendationText += '<br>üî¥ SQL Injection –∞—Ç–∞–∫–∏ - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∞–ª–∏–¥–∞—Ü–∏—é –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.';
            }
            if (threats.xss > 0) {
                recommendationText += '<br>üü† XSS –∞—Ç–∞–∫–∏ - —É—Å–∏–ª—å—Ç–µ –∑–∞—â–∏—Ç—É –æ—Ç —Å–∫—Ä–∏–ø—Ç–æ–≤.';
            }
            if (threats.cmdi > 0) {
                recommendationText += '<br>üü£ Command Injection - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∫–æ–º–∞–Ω–¥.';
            }
            if (threats.pathtraversal > 0) {
                recommendationText += '<br>üîµ Path Traversal - —É—Å–∏–ª—å—Ç–µ –∫–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª–∞–º.';
            }

            recommendations.innerHTML = recommendationText || '<p>‚úì –ù–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π</p>';
        }

        // WebSocket –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
        const ws = new WebSocket(`ws://${window.location.host}/api/ws`);
        
        ws.onmessage = function(event) {
            const stats = JSON.parse(event.data);
            updateCharts(stats);
            updateStatsDisplay(stats);
        };

        // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
        loadStats();
        
        // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
        setInterval(loadStats, 10000);
    </script>
</body>
</html>