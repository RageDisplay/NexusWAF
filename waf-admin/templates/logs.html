<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–õ–æ–≥–∏ WAF - NexusWAF</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        .filter-container {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            align-items: flex-end;
        }
        
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        
        .filter-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #0ea5e9;
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .filter-group input,
        .filter-group select {
            width: 100%;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
            <a href="/" class="navbar-brand" style="display: flex; align-items: center; gap: 0.75rem;"><svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg" style="filter: drop-shadow(0 0 10px rgba(6, 182, 212, 0.6));"><path d="M16 2L4 8V14C4 23 16 30 16 30C16 30 28 23 28 14V8L16 2Z" fill="url(#gradient)" stroke="#0ea5e9" stroke-width="1.5"/><defs><linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#06b6d4;stop-opacity:1" /><stop offset="100%" style="stop-color:#0ea5e9;stop-opacity:1" /></linearGradient></defs></svg>NexusWAF</a>
            <ul class="navbar-nav">
                <li><a href="/" class="nav-link">–ì–ª–∞–≤–Ω–∞—è</a></li>
                <li><a href="/config" class="nav-link">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</a></li>
                <li><a href="/logs" class="nav-link active">–õ–æ–≥–∏</a></li>
                <li><a href="/stats" class="nav-link">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <div class="card">
            <h2 style="display: flex; align-items: center; gap: 0.5rem;">–õ–æ–≥–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</h2>
            
            <!-- Filter Section -->
            <div style="margin-top: 2rem; padding: 1.5rem; background: rgba(6, 182, 212, 0.05); border-radius: 12px; border: 1px solid rgba(6, 182, 212, 0.1);">
                <div style="color: #0ea5e9; font-weight: 600; margin-bottom: 1rem;">–ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è</div>
                
                <div class="filter-container">
                    <div class="filter-group">
                        <label for="filterIP">IP –∞–¥—Ä–µ—Å</label>
                        <input id="filterIP" class="form-control" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 192.168.1.1" />
                    </div>
                    
                    <div class="filter-group">
                        <label for="filterMethod">–ú–µ—Ç–æ–¥ –∑–∞–ø—Ä–æ—Å–∞</label>
                        <select id="filterMethod" class="form-control">
                            <option value="">–í—Å–µ –º–µ—Ç–æ–¥—ã</option>
                            <option>GET</option>
                            <option>POST</option>
                            <option>PUT</option>
                            <option>DELETE</option>
                            <option>PATCH</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="filterThreat">–¢–∏–ø —É–≥—Ä–æ–∑—ã</label>
                        <input id="filterThreat" class="form-control" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä sqli, xss..." />
                    </div>
                    
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-primary" onclick="applyFilters()" style="white-space: nowrap;">–ù–∞–π—Ç–∏</button>
                        <button class="btn" onclick="clearFilters()" style="background: rgba(6, 182, 212, 0.1); color: #0ea5e9; border: 1px solid rgba(6, 182, 212, 0.3); white-space: nowrap;">–°–±—Ä–æ—Å</button>
                    </div>
                </div>
            </div>

            <!-- Logs Container -->
            <div id="logsContainer" style="margin-top: 2rem;">
                <div style="text-align: center; padding: 3rem; color: #94a3b8;">
                    <div class="loading" style="margin: 0 auto 1rem;"></div>
                    <div>–ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ–≤...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        async function loadLogs() {
            try {
                const response = await fetch('/api/logs');
                const logs = await response.json();
                
                const container = document.getElementById('logsContainer');
                
                if (!logs || logs.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 3rem; color: #94a3b8;">üì≠ –õ–æ–≥–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</div>';
                    return;
                }

                window._wafLogs = logs;
                renderLogs(logs);
            } catch (error) {
                document.getElementById('logsContainer').innerHTML = '<div style="text-align: center; padding: 3rem; color: #ef4444;">‚úï –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ–≤: ' + error.message + '</div>';
            }
        }

        function renderLogs(logs) {
            const container = document.getElementById('logsContainer');
            
            if (logs.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 3rem; color: #94a3b8;">üì≠ –ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ –≤–∞—à–µ–º—É —Ñ–∏–ª—å—Ç—Ä—É</div>';
                return;
            }
            
            container.innerHTML = logs.map((log, index) => {
                const time = new Date(log.timestamp).toLocaleString('ru-RU');
                const actionClass = log.action === 'block' ? 'badge-danger' : 'badge-success';
                const actionIcon = log.action === 'block' ? 'üö´' : '‚úì';
                const threats = (log.threats || []).map(t => `<span class="log-threat">${t}</span>`).join('');
                const shortUrl = log.url.length > 130 ? log.url.slice(0, 127) + '...' : log.url;
                
                return `
                    <div class="log-entry" style="animation: slideIn 0.4s ease-out backwards; animation-delay: ${index * 0.05}s;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem;">
                            <div style="flex: 1; min-width: 200px;">
                                <div style="color: #94a3b8; font-size: 0.85rem; margin-bottom: 0.25rem;">${time}</div>
                                <div style="display: flex; gap: 0.75rem; align-items: center; margin-top: 0.5rem;">
                                    <span class="badge ${actionClass}">${actionIcon} ${log.action.toUpperCase()}</span>
                                </div>
                            </div>
                            <button class="btn" onclick='copyToClipboard("${escapeHtml(log.ip)} ${escapeHtml(log.method)} ${escapeHtml(log.url)}")' style="background: rgba(6, 182, 212, 0.1); color: #0ea5e9; border: 1px solid rgba(6, 182, 212, 0.2); padding: 0.5rem 1rem;" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 1rem; padding: 1rem; background: rgba(15, 23, 42, 0.5); border-radius: 8px;">
                            <div>
                                <div style="color: #94a3b8; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 0.5rem;">IP –∞–¥—Ä–µ—Å</div>
                                <div style="color: #0ea5e9; font-weight: 600; font-family: 'Monaco', monospace;">${escapeHtml(log.ip)}</div>
                            </div>
                            <div>
                                <div style="color: #94a3b8; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 0.5rem;">–ú–µ—Ç–æ–¥</div>
                                <div style="color: #0ea5e9; font-weight: 600; font-family: 'Monaco', monospace;">${escapeHtml(log.method)}</div>
                            </div>
                            <div style="grid-column: 1 / -1;">
                                <div style="color: #94a3b8; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 0.5rem;">URL</div>
                                <div style="color: #0ea5e9; font-weight: 600; word-break: break-all; font-family: 'Monaco', monospace; font-size: 0.9rem;" title="${escapeHtml(log.url)}">${escapeHtml(shortUrl)}</div>
                            </div>
                        </div>
                        
                        ${threats ? `<div style="display: flex; gap: 0.5rem; flex-wrap: wrap;"><strong style="color: #94a3b8; width: 100%;">üö® –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ —É–≥—Ä–æ–∑—ã:</strong> ${threats}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function escapeHtml(s) {
            if (!s) return '';
            return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        }

        function copyToClipboard(text) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    const btn = event.target;
                    const originalText = btn.textContent;
                    btn.textContent = '‚úì –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                    btn.style.background = 'rgba(16, 185, 129, 0.2)';
                    btn.style.color = '#10b981';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = 'rgba(6, 182, 212, 0.1)';
                        btn.style.color = '#0ea5e9';
                    }, 2000);
                });
            }
        }

        function applyFilters() {
            const ip = document.getElementById('filterIP').value.trim().toLowerCase();
            const method = document.getElementById('filterMethod').value.trim().toUpperCase();
            const threat = document.getElementById('filterThreat').value.trim().toLowerCase();
            let logs = window._wafLogs || [];
            
            if (ip) logs = logs.filter(l => (l.ip || '').toLowerCase().includes(ip));
            if (method) logs = logs.filter(l => (l.method || '').toUpperCase() === method);
            if (threat) logs = logs.filter(l => (l.threats || []).some(t => t.toLowerCase().includes(threat)));
            
            renderLogs(logs);
        }

        function clearFilters() {
            document.getElementById('filterIP').value = '';
            document.getElementById('filterMethod').value = '';
            document.getElementById('filterThreat').value = '';
            renderLogs(window._wafLogs || []);
        }

        loadLogs();
        setInterval(loadLogs, 10000);
    </script>
</body>
</html>